var util=require("./util");var easing={easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}};function makePiece(k,piece,invert){var key=invert?util.invertKey(k):k;return{key:key,pos:util.key2pos(key),role:piece.role,color:piece.color}}function samePiece(p1,p2){return p1.role===p2.role&&p1.color===p2.color}function closer(piece,pieces){return pieces.sort(function(p1,p2){return util.distance(piece.pos,p1.pos)-util.distance(piece.pos,p2.pos)})[0]}function computePlan(prev,current){var bounds=current.bounds(),width=bounds.width/8,height=bounds.height/8,anims={},animedOrigs=[],fadings=[],missings=[],news=[],invert=prev.orientation!==current.orientation,prePieces={},white=current.orientation==="white";for(var pk in prev.pieces){var piece=makePiece(pk,prev.pieces[pk],invert);prePieces[piece.key]=piece}for(var i=0;i<util.allKeys.length;i++){var key=util.allKeys[i];if(key!==current.movable.dropped[1]){var curP=current.pieces[key];var preP=prePieces[key];if(curP){if(preP){if(!samePiece(curP,preP)){missings.push(preP);news.push(makePiece(key,curP,false))}}else news.push(makePiece(key,curP,false))}else if(preP)missings.push(preP)}}news.forEach(function(newP){var preP=closer(newP,missings.filter(util.partial(samePiece,newP)));if(preP){var orig=white?preP.pos:newP.pos;var dest=white?newP.pos:preP.pos;var vector=[(orig[0]-dest[0])*width,(dest[1]-orig[1])*height];anims[newP.key]=[vector,vector];animedOrigs.push(preP.key)}});missings.forEach(function(p){if(p.key!==current.movable.dropped[0]&&!util.containsX(animedOrigs,p.key)){fadings.push({piece:{role:p.role,color:p.color},left:12.5*(white?p.pos[0]-1:8-p.pos[0])+"%",bottom:12.5*(white?p.pos[1]-1:8-p.pos[1])+"%",opacity:1})}});return{anims:anims,fadings:fadings}}function roundBy(n,by){return Math.round(n*by)/by}function go(data){if(!data.animation.current.start)return;var rest=1-((new Date).getTime()-data.animation.current.start)/data.animation.current.duration;if(rest<=0){data.animation.current={};data.render()}else{var ease=easing.easeInOutCubic(rest);for(var key in data.animation.current.anims){var cfg=data.animation.current.anims[key];cfg[1]=[roundBy(cfg[0][0]*ease,10),roundBy(cfg[0][1]*ease,10)]}for(var i in data.animation.current.fadings){data.animation.current.fadings[i].opacity=roundBy(ease,100)}data.render();util.requestAnimationFrame(function(){go(data)})}}function animate(transformation,data){var prev={orientation:data.orientation,pieces:{}};for(var key in data.pieces){prev.pieces[key]={role:data.pieces[key].role,color:data.pieces[key].color}}var result=transformation();var plan=computePlan(prev,data);if(Object.keys(plan.anims).length>0||plan.fadings.length>0){var alreadyRunning=data.animation.current.start;data.animation.current={start:(new Date).getTime(),duration:data.animation.duration,anims:plan.anims,fadings:plan.fadings};if(!alreadyRunning)go(data)}else{data.renderRAF()}return result}module.exports=function(transformation,data,skip){return function(){var transformationArgs=[data].concat(Array.prototype.slice.call(arguments,0));if(!data.render)return transformation.apply(null,transformationArgs);else if(data.animation.enabled&&!skip)return animate(util.partialApply(transformation,transformationArgs),data);else{var result=transformation.apply(null,transformationArgs);data.renderRAF();return result}}};var board=require("./board");module.exports=function(controller){return{set:controller.set,toggleOrientation:controller.toggleOrientation,getOrientation:function(){return controller.data.orientation},getPieces:function(){return controller.data.pieces},getMaterialDiff:function(){return board.getMaterialDiff(controller.data)},getFen:controller.getFen,dump:function(){return controller.data},move:controller.apiMove,setPieces:controller.setPieces,setCheck:controller.setCheck,playPremove:controller.playPremove,cancelPremove:controller.cancelPremove,cancelMove:controller.cancelMove,stop:controller.stop,explode:controller.explode}};var util=require("./util");var premove=require("./premove");var anim=require("./anim");var hold=require("./hold");function callUserFunction(f){setTimeout(f,1)}function toggleOrientation(data){data.orientation=util.opposite(data.orientation)}function reset(data){data.lastMove=null;setSelected(data,null);unsetPremove(data)}function setPieces(data,pieces){Object.keys(pieces).forEach(function(key){if(pieces[key])data.pieces[key]=pieces[key];else delete data.pieces[key]});data.movable.dropped=[]}function setCheck(data,color){var checkColor=color||data.turnColor;Object.keys(data.pieces).forEach(function(key){if(data.pieces[key].color===checkColor&&data.pieces[key].role==="king")data.check=key})}function setPremove(data,orig,dest){data.premovable.current=[orig,dest];callUserFunction(util.partial(data.premovable.events.set,orig,dest))}function unsetPremove(data){if(data.premovable.current){data.premovable.current=null;callUserFunction(data.premovable.events.unset)}}function tryAutoCastle(data,orig,dest){if(!data.autoCastle)return;var king=data.pieces[dest];if(king.role!=="king")return;var origPos=util.key2pos(orig);if(origPos[0]!==5)return;if(origPos[1]!==1&&origPos[1]!==8)return;var destPos=util.key2pos(dest),oldRookPos,newRookPos,newKingPos;if(destPos[0]===7||destPos[0]===8){oldRookPos=util.pos2key([8,origPos[1]]);newRookPos=util.pos2key([6,origPos[1]]);newKingPos=util.pos2key([7,origPos[1]])}else if(destPos[0]===3||destPos[0]===1){oldRookPos=util.pos2key([1,origPos[1]]);newRookPos=util.pos2key([4,origPos[1]]);newKingPos=util.pos2key([3,origPos[1]])}else return;delete data.pieces[orig];delete data.pieces[dest];delete data.pieces[oldRookPos];data.pieces[newKingPos]={role:"king",color:king.color};data.pieces[newRookPos]={role:"rook",color:king.color}}function baseMove(data,orig,dest){var success=anim(function(){if(orig===dest||!data.pieces[orig])return false;var captured=data.pieces[dest]&&data.pieces[dest].color!==data.pieces[orig].color?data.pieces[dest]:null;callUserFunction(util.partial(data.events.move,orig,dest,captured));data.pieces[dest]=data.pieces[orig];delete data.pieces[orig];data.lastMove=[orig,dest];data.check=null;tryAutoCastle(data,orig,dest);callUserFunction(data.events.change);return true},data)();if(success)data.movable.dropped=[];return success}function baseUserMove(data,orig,dest){var result=baseMove(data,orig,dest);if(result){data.movable.dests={};data.turnColor=util.opposite(data.turnColor)}return result}function apiMove(data,orig,dest){return baseMove(data,orig,dest)}function userMove(data,orig,dest){if(!dest){setSelected(data,null);if(data.movable.dropOff==="trash"){delete data.pieces[orig];callUserFunction(data.events.change)}}else if(canMove(data,orig,dest)){if(baseUserMove(data,orig,dest)){setSelected(data,null);callUserFunction(util.partial(data.movable.events.after,orig,dest,{premove:false,holdTime:hold.stop()}))}}else if(canPremove(data,orig,dest)){setPremove(data,orig,dest);setSelected(data,null)}else if(isMovable(data,dest)||isPremovable(data,dest))setSelected(data,dest);else setSelected(data,null)}function selectSquare(data,key){if(data.selected){if(key){if(data.selected!==key)userMove(data,data.selected,key)}else setSelected(data,null)}else if(isMovable(data,key)||isPremovable(data,key))setSelected(data,key);if(key)callUserFunction(util.partial(data.events.select,key))}function setSelected(data,key){data.selected=key;if(key&&isPremovable(data,key))data.premovable.dests=premove(data.pieces,key,data.premovable.castle);else data.premovable.dests=null}function isMovable(data,orig){var piece=data.pieces[orig];return piece&&(data.movable.color==="both"||data.movable.color===piece.color&&data.turnColor===piece.color)}function canMove(data,orig,dest){return orig!==dest&&isMovable(data,orig)&&(data.movable.free||util.containsX(data.movable.dests[orig],dest))}function isPremovable(data,orig){var piece=data.pieces[orig];return piece&&data.premovable.enabled&&data.movable.color===piece.color&&data.turnColor!==piece.color}function canPremove(data,orig,dest){return orig!==dest&&isPremovable(data,orig)&&util.containsX(premove(data.pieces,orig,data.premovable.castle),dest)}function isDraggable(data,orig){var piece=data.pieces[orig];return piece&&data.draggable.enabled&&(data.movable.color==="both"||data.movable.color===piece.color&&(data.turnColor===piece.color||data.premovable.enabled))}function playPremove(data){var move=data.premovable.current;if(!move)return;var orig=move[0],dest=move[1];if(canMove(data,orig,dest)){if(baseUserMove(data,orig,dest)){callUserFunction(util.partial(data.movable.events.after,orig,dest,{premove:true}))}}unsetPremove(data)}function cancelMove(data){unsetPremove(data);selectSquare(data,null)}function stop(data){data.movable.color=null;data.movable.dests={};cancelMove(data)}function getKeyAtDomPos(data,pos,bounds){if(!bounds&&!data.bounds)return;bounds=bounds||data.bounds();var file=Math.ceil(8*((pos[0]-bounds.left)/bounds.width));file=data.orientation==="white"?file:9-file;var rank=Math.ceil(8-8*((pos[1]-bounds.top)/bounds.height));rank=data.orientation==="white"?rank:9-rank;if(file>0&&file<9&&rank>0&&rank<9)return util.pos2key([file,rank])}function getMaterialDiff(data){var counts={king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0};for(var k in data.pieces){var p=data.pieces[k];counts[p.role]+=p.color==="white"?1:-1}var diff={white:{},black:{}};for(var role in counts){var c=counts[role];if(c>0)diff.white[role]=c;else if(c<0)diff.black[role]=-c}return diff}module.exports={reset:reset,toggleOrientation:toggleOrientation,setPieces:setPieces,setCheck:setCheck,selectSquare:selectSquare,setSelected:setSelected,isDraggable:isDraggable,canMove:canMove,userMove:userMove,apiMove:apiMove,playPremove:playPremove,unsetPremove:unsetPremove,cancelMove:cancelMove,stop:stop,getKeyAtDomPos:getKeyAtDomPos,getMaterialDiff:getMaterialDiff};var merge=require("merge");var board=require("./board");var fen=require("./fen");module.exports=function(data,config){if(!config)return;if(config.movable&&config.movable.dests)delete data.movable.dests;merge.recursive(data,config);if(data.fen){data.pieces=fen.read(data.fen);data.check=config.check;data.drawable.shapes=[];delete data.fen}if(data.check===true)board.setCheck(data);data.movable.dropped=[];if(data.selected)board.setSelected(data,data.selected);if(!data.animation.duration||data.animation.duration<10)data.animation.enabled=false};var board=require("./board");var data=require("./data");var fen=require("./fen");var configure=require("./configure");var anim=require("./anim");var drag=require("./drag");module.exports=function(cfg){this.data=data(cfg);this.vm={exploding:false};this.getFen=function(){return fen.write(this.data.pieces)}.bind(this);this.set=anim(configure,this.data);this.toggleOrientation=anim(board.toggleOrientation,this.data);this.setPieces=anim(board.setPieces,this.data);this.selectSquare=anim(board.selectSquare,this.data,true);this.apiMove=anim(board.apiMove,this.data);this.playPremove=anim(board.playPremove,this.data);this.cancelPremove=anim(board.unsetPremove,this.data,true);this.setCheck=anim(board.setCheck,this.data,true);this.cancelMove=anim(function(data){board.cancelMove(data);drag.cancel(data)}.bind(this),this.data,true);this.stop=anim(function(data){board.stop(data);drag.cancel(data)}.bind(this),this.data,true);this.explode=function(keys){if(!this.data.render)return;this.vm.exploding=keys;this.data.renderRAF();setTimeout(function(){this.vm.exploding=false;this.data.renderRAF()}.bind(this),200)}.bind(this)};var fen=require("./fen");var configure=require("./configure");module.exports=function(cfg){var defaults={pieces:fen.read(fen.initial),orientation:"white",turnColor:"white",check:null,lastMove:null,selected:null,coordinates:true,render:null,renderRAF:null,element:null,bounds:null,autoCastle:false,viewOnly:false,minimalDom:false,disableContextMenu:false,highlight:{lastMove:true,check:true,dragOver:true},animation:{enabled:true,duration:200,current:{}},movable:{free:true,color:"both",dests:{},dropOff:"revert",dropped:[],showDests:true,events:{after:function(orig,dest,metadata){}}},premovable:{enabled:true,showDests:true,castle:true,dests:[],current:null,events:{set:function(orig,dest){},unset:function(){}}},draggable:{enabled:true,distance:3,squareTarget:false,centerPiece:true,showGhost:true,current:{}},events:{change:function(){},move:function(orig,dest,capturedPiece){},capture:function(key,piece){},select:function(key){},afterDraw:function(){}},drawable:{enabled:false,shapes:[],current:{}}};configure(defaults,cfg||{});return defaults};var board=require("./board");var util=require("./util");var hold=require("./hold");var originTarget;function hashPiece(piece){return piece?piece.color+" "+piece.role:""}function start(data,e){if(e.button!==undefined&&e.button!==0)return;if(e.touches&&e.touches.length>1)return;e.stopPropagation();e.preventDefault();originTarget=e.target;var previouslySelected=data.selected;var position=util.eventPosition(e);var bounds=data.bounds();var orig=board.getKeyAtDomPos(data,position,bounds);var hadPremove=!!data.premovable.current;board.selectSquare(data,orig);var stillSelected=data.selected===orig;if(data.pieces[orig]&&stillSelected&&board.isDraggable(data,orig)){var pieceBounds=data.element.querySelector("."+orig).getBoundingClientRect();data.draggable.current={previouslySelected:previouslySelected,orig:orig,piece:hashPiece(data.pieces[orig]),rel:position,epos:position,pos:[0,0],dec:data.draggable.centerPiece?[position[0]-(pieceBounds.left+pieceBounds.width/2),position[1]-(pieceBounds.top+pieceBounds.height/2)]:[0,0],bounds:bounds,started:false};hold.start()}else if(hadPremove)board.unsetPremove(data);processDrag(data)}function processDrag(data){util.requestAnimationFrame(function(){var cur=data.draggable.current;if(cur.orig){if(data.animation.current.start&&Object.keys(data.animation.current.anims).indexOf(cur.orig)!==-1)data.animation.current={};if(hashPiece(data.pieces[cur.orig])!==cur.piece)cancel(data);else{if(!cur.started&&util.distance(cur.epos,cur.rel)>=data.draggable.distance)cur.started=true;if(cur.started){cur.pos=[cur.epos[0]-cur.rel[0],cur.epos[1]-cur.rel[1]];cur.over=board.getKeyAtDomPos(data,cur.epos,cur.bounds)}}}data.render();if(cur.orig)processDrag(data)})}function move(data,e){if(e.touches&&e.touches.length>1)return;if(data.draggable.current.orig)data.draggable.current.epos=util.eventPosition(e)}function end(data,e){var draggable=data.draggable;var orig=draggable.current?draggable.current.orig:null;var dest;if(!orig)return;if(e&&e.type==="touchend"&&originTarget!==e.target)return;board.unsetPremove(data);if(draggable.current.started){dest=draggable.current.over;if(orig!==dest)data.movable.dropped=[orig,dest];board.userMove(data,orig,dest)}else if(draggable.current.previouslySelected===orig)board.setSelected(data,null);draggable.current={}}function cancel(data){if(data.draggable.current.orig){data.draggable.current={};board.selectSquare(data,null)}}module.exports={start:start,move:move,end:end,cancel:cancel,processDrag:processDrag};var board=require("./board");var util=require("./util");function hashPiece(piece){return piece?piece.color+" "+piece.role:""}function start(data,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation();e.preventDefault();board.cancelMove(data);var position=util.eventPosition(e);var bounds=data.bounds();var orig=board.getKeyAtDomPos(data,position,bounds);data.drawable.current={orig:orig,over:orig,epos:position,bounds:bounds};processDraw(data)}function processDraw(data){util.requestAnimationFrame(function(){var cur=data.drawable.current;if(cur.orig)cur.over=board.getKeyAtDomPos(data,cur.epos,cur.bounds);data.render();if(cur.orig)processDraw(data)})}function move(data,e){if(data.drawable.current.orig)data.drawable.current.epos=util.eventPosition(e)}function end(data,e){var drawable=data.drawable;var orig=drawable.current.orig;var dest=drawable.current.over;if(!orig||!dest)return;if(orig===dest)addCircle(drawable,orig);else addLine(drawable,orig,dest);drawable.current={};data.render()}function cancel(data){if(data.drawable.current.orig)data.drawable.current={}}function clear(data,e){if(e.button!==0||e.shiftKey)return;data.drawable.shapes=[];data.render()}function not(f){return function(x){return!f(x)}}function addCircle(drawable,key){var sameCircle=function(s){return s.length===1&&s[0]===key};var exists=drawable.shapes.filter(sameCircle).length>0;if(exists)drawable.shapes=drawable.shapes.filter(not(sameCircle));else drawable.shapes.push([key])}function addLine(drawable,orig,dest){var sameLine=function(s){return s.length===2&&(s[0]===orig&&s[1]===dest||s[1]===orig&&s[0]===dest)};var exists=drawable.shapes.filter(sameLine).length>0;if(exists)drawable.shapes=drawable.shapes.filter(not(sameLine));else drawable.shapes.push([orig,dest])}module.exports={start:start,move:move,end:end,cancel:cancel,clear:clear,processDraw:processDraw};var util=require("./util");var initial="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR";var roles={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"};var letters={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function read(fen){if(fen==="start")fen=initial;var pieces={};fen.replace(/ .+$/,"").split("/").forEach(function(row,y){var x=0;row.split("").forEach(function(v){var nb=parseInt(v);if(nb)x+=nb;else{x++;pieces[util.pos2key([x,8-y])]={role:roles[v.toLowerCase()],color:v===v.toLowerCase()?"black":"white"}}})});return pieces}function write(pieces){return[8,7,6,5,4,3,2].reduce(function(str,nb){return str.replace(new RegExp(Array(nb+1).join("1"),"g"),nb)},util.invRanks.map(function(y){return util.ranks.map(function(x){var piece=pieces[util.pos2key([x,y])];if(piece){var letter=letters[piece.role];return piece.color==="white"?letter.toUpperCase():letter}else return"1"}).join("")}).join("/"))}module.exports={initial:initial,read:read,write:write};var startAt;var start=function(){startAt=new Date};var cancel=function(){startAt=null};var stop=function(){if(!startAt)return 0;var time=new Date-startAt;startAt=null;return time};module.exports={start:start,cancel:cancel,stop:stop};var m=require("mithril");var ctrl=require("./ctrl");var view=require("./view");var api=require("./api");function init(element,config){var controller=new ctrl(config);m.render(element,view(controller));return api(controller)}module.exports=init;module.exports.controller=ctrl;module.exports.view=view;module.exports.fen=require("./fen");module.exports.util=require("./util");module.exports.configure=require("./configure");module.exports.anim=require("./anim");module.exports.board=require("./board");module.exports.drag=require("./drag");var util=require("./util");function diff(a,b){return Math.abs(a-b)}function pawn(color,x1,y1,x2,y2){return diff(x1,x2)<2&&(color==="white"?y2===y1+1||y1<=2&&y2===y1+2&&x1===x2:y2===y1-1||y1>=7&&y2===y1-2&&x1===x2)}function knight(x1,y1,x2,y2){var xd=diff(x1,x2);var yd=diff(y1,y2);return xd===1&&yd===2||xd===2&&yd===1}function bishop(x1,y1,x2,y2){return diff(x1,x2)===diff(y1,y2)}function rook(x1,y1,x2,y2){return x1===x2||y1===y2}function queen(x1,y1,x2,y2){return bishop(x1,y1,x2,y2)||rook(x1,y1,x2,y2)}function king(color,rookFiles,canCastle,x1,y1,x2,y2){return diff(x1,x2)<2&&diff(y1,y2)<2||canCastle&&y1===y2&&y1===(color==="white"?1:8)&&(x1===5&&(x2===3||x2===7)||util.containsX(rookFiles,x2))}function rookFilesOf(pieces,color){return Object.keys(pieces).filter(function(key){var piece=pieces[key];return piece&&piece.color===color&&piece.role==="rook"}).map(function(key){return util.key2pos(key)[0]})}function compute(pieces,key,canCastle){var piece=pieces[key];var pos=util.key2pos(key);var mobility;switch(piece.role){case"pawn":mobility=pawn.bind(null,piece.color);break;case"knight":mobility=knight;break;case"bishop":mobility=bishop;break;case"rook":mobility=rook;break;case"queen":mobility=queen;break;case"king":mobility=king.bind(null,piece.color,rookFilesOf(pieces,piece.color),canCastle);break}return util.allPos.filter(function(pos2){return(pos[0]!==pos2[0]||pos[1]!==pos2[1])&&mobility(pos[0],pos[1],pos2[0],pos2[1])}).map(util.pos2key)}module.exports=compute;var m=require("mithril");var key2pos=require("./util").key2pos;function callUserFunction(f){setTimeout(f,1)}var color="#008800";var bounds;function circleWidth(light){return(light?2:4)/512*bounds.width}function lineWidth(light){return(light?7:10)/512*bounds.width}function opacity(light){return light?.5:1}function arrowMargin(){return 24/512*bounds.width}function pos2px(pos){var squareSize=bounds.width/8;return[(pos[0]-.5)*squareSize,(8.5-pos[1])*squareSize]}function circle(pos,light){var o=pos2px(pos);var width=circleWidth(light);var radius=bounds.width/16;return{tag:"circle",attrs:{stroke:color,"stroke-width":width,fill:"none",opacity:opacity(light),cx:o[0],cy:o[1],r:radius-width/2}}}function arrow(orig,dest,light){var m=arrowMargin();var a=pos2px(orig);var b=pos2px(dest);var dx=b[0]-a[0],dy=b[1]-a[1],angle=Math.atan2(dy,dx);var xo=Math.cos(angle)*m,yo=Math.sin(angle)*m;return{tag:"line",attrs:{stroke:color,"stroke-width":lineWidth(light),"stroke-linecap":"round","marker-end":"url(#arrowhead)",opacity:opacity(light),x1:a[0],y1:a[1],x2:b[0]-xo,y2:b[1]-yo}}}var defs=m("defs",m("marker",{id:"arrowhead",orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01},m("path",{d:"M0,0 V4 L3,2 Z",fill:color})));function orient(pos,color){return color==="white"?pos:[9-pos[0],9-pos[1]]}function computeShape(orientation){return function(s){return s.map(function(k){return orient(key2pos(k),orientation)})}}function samePos(p1,p2){return p1[0]===p2[0]&&p1[1]===p2[1]}function renderCurrent(data){var c=data.drawable.current;if(!c.orig||!c.over)return;var shape=computeShape(data.orientation)(c.orig===c.over?[c.orig]:[c.orig,c.over]);callUserFunction(data.events.afterDraw);return shape.length===1?circle(shape[0],true):arrow(shape[0],shape[1],true)}module.exports=function(ctrl){if(!ctrl.data.bounds)return;var shapes=ctrl.data.drawable.shapes.map(computeShape(ctrl.data.orientation));if(!shapes.length&&!ctrl.data.drawable.current.orig)return;if(!bounds)bounds=ctrl.data.bounds();if(bounds.width!==bounds.height)return;return{tag:"svg",children:[defs,shapes.map(function(shape){if(shape.length===1)return circle(shape[0],false);if(shape.length===2)return arrow(shape[0],shape[1],false)}),renderCurrent(ctrl.data)]}};var files="abcdefgh".split("");var ranks=[1,2,3,4,5,6,7,8];var invRanks=[8,7,6,5,4,3,2,1];function pos2key(pos){return files[pos[0]-1]+pos[1]}function key2pos(pos){return[files.indexOf(pos[0])+1,parseInt(pos[1])]}function invertKey(key){return files[7-files.indexOf(key[0])]+(9-parseInt(key[1]))}var allPos=function(){var ps=[];invRanks.forEach(function(y){ranks.forEach(function(x){ps.push([x,y])})});return ps}();var invPos=allPos.slice().reverse();var allKeys=allPos.map(pos2key);function classSet(classes){var arr=[];for(var i in classes){if(classes[i])arr.push(i)}return arr.join(" ")}function opposite(color){return color==="white"?"black":"white"}function contains2(xs,x){return xs&&(xs[0]===x||xs[1]===x)}function containsX(xs,x){return xs&&xs.indexOf(x)!==-1}function distance(pos1,pos2){return Math.sqrt(Math.pow(pos1[0]-pos2[0],2)+Math.pow(pos1[1]-pos2[1],2))}var cachedTransformProp;function computeTransformProp(){return"transform"in document.body.style?"transform":"webkitTransform"in document.body.style?"webkitTransform":"mozTransform"in document.body.style?"mozTransform":"oTransform"in document.body.style?"oTransform":"msTransform"}function transformProp(){if(!cachedTransformProp)cachedTransformProp=computeTransformProp();return cachedTransformProp}function translate(pos){return"translate3d("+pos[0]+"px,"+pos[1]+"px,0)"}function eventPosition(e){return e.touches?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:[e.clientX,e.clientY]}function partialApply(fn,args){return fn.bind.apply(fn,[null].concat(args))}function partial(){return partialApply(arguments[0],Array.prototype.slice.call(arguments,1))}function isRightButton(e){return e.buttons===2||e.button===2}module.exports={files:files,ranks:ranks,invRanks:invRanks,allPos:allPos,invPos:invPos,allKeys:allKeys,pos2key:pos2key,key2pos:key2pos,invertKey:invertKey,classSet:classSet,opposite:opposite,translate:translate,contains2:contains2,containsX:containsX,distance:distance,eventPosition:eventPosition,partialApply:partialApply,partial:partial,transformProp:transformProp,requestAnimationFrame:(window.requestAnimationFrame||window.setTimeout).bind(window),isRightButton:isRightButton};var drag=require("./drag");var draw=require("./draw");var util=require("./util");var svg=require("./svg");var m=require("mithril");function pieceClass(p){return["cg-piece",p.role,p.color].join(" ")}function renderPiece(ctrl,key,p){var attrs={style:{},"class":pieceClass(p)};var draggable=ctrl.data.draggable.current;if(draggable.orig===key&&(draggable.pos[0]!==0||draggable.pos[1]!==0)){attrs.style[util.transformProp()]=util.translate([draggable.pos[0]+draggable.dec[0],draggable.pos[1]+draggable.dec[1]]);attrs.class+=" dragging"}else if(ctrl.data.animation.current.anims){var animation=ctrl.data.animation.current.anims[key];if(animation)attrs.style[util.transformProp()]=util.translate(animation[1])}return{tag:"div",attrs:attrs}}function renderGhost(p){return{tag:"div",attrs:{"class":pieceClass(p)+" ghost"}}}function renderSquare(ctrl,pos,asWhite){var file=util.files[pos[0]-1];var rank=pos[1];var key=file+rank;var piece=ctrl.data.pieces[key];var isDragOver=ctrl.data.highlight.dragOver&&ctrl.data.draggable.current.over===key;var attrs={"class":"cg-square "+key+" "+util.classSet({selected:ctrl.data.selected===key,check:ctrl.data.highlight.check&&ctrl.data.check===key,"last-move":ctrl.data.highlight.lastMove&&util.contains2(ctrl.data.lastMove,key),"move-dest":(isDragOver||ctrl.data.movable.showDests)&&util.containsX(ctrl.data.movable.dests[ctrl.data.selected],key),"premove-dest":(isDragOver||ctrl.data.premovable.showDests)&&util.containsX(ctrl.data.premovable.dests,key),"current-premove":util.contains2(ctrl.data.premovable.current,key),"drag-over":isDragOver,occupied:!!piece,exploding:ctrl.vm.exploding&&ctrl.vm.exploding.indexOf(key)!==-1}),style:{left:(asWhite?pos[0]-1:8-pos[0])*12.5+"%",bottom:(asWhite?pos[1]-1:8-pos[1])*12.5+"%"}};if(ctrl.data.coordinates){if(pos[1]===(asWhite?1:8))attrs["data-coord-x"]=file;if(pos[0]===(asWhite?8:1))attrs["data-coord-y"]=rank}var children=[];if(piece){children.push(renderPiece(ctrl,key,piece));if(ctrl.data.draggable.current.orig===key&&ctrl.data.draggable.showGhost){children.push(renderGhost(piece))}}return{tag:"div",attrs:attrs,children:children}}function renderSquareTarget(ctrl,cur){var pos=util.key2pos(cur.over),x=ctrl.data.orientation==="white"?pos[0]:9-pos[0],y=ctrl.data.orientation==="white"?pos[1]:9-pos[1];return{tag:"div",attrs:{id:"cg-square-target",style:{width:cur.bounds.width/4+"px",height:cur.bounds.height/4+"px",left:(x-1.5)*cur.bounds.width/8+"px",top:(7.5-y)*cur.bounds.height/8+"px"}}}}function renderFading(cfg){return{tag:"div",attrs:{"class":"cg-square fading",style:{left:cfg.left,bottom:cfg.bottom,opacity:cfg.opacity}},children:[{tag:"div",attrs:{"class":pieceClass(cfg.piece)}}]}}function renderMinimalDom(ctrl,asWhite){var children=[];if(ctrl.data.lastMove)ctrl.data.lastMove.forEach(function(key){var pos=util.key2pos(key);children.push({tag:"div",attrs:{"class":"cg-square last-move",style:{left:(asWhite?pos[0]-1:8-pos[0])*12.5+"%",bottom:(asWhite?pos[1]-1:8-pos[1])*12.5+"%"}}})});var piecesKeys=Object.keys(ctrl.data.pieces);for(var i=0,len=piecesKeys.length;i<len;i++){var key=piecesKeys[i];var pos=util.key2pos(key);var attrs={style:{left:(asWhite?pos[0]-1:8-pos[0])*12.5+"%",bottom:(asWhite?pos[1]-1:8-pos[1])*12.5+"%"},"class":pieceClass(ctrl.data.pieces[key])};if(ctrl.data.animation.current.anims){var animation=ctrl.data.animation.current.anims[key];if(animation)attrs.style[util.transformProp()]=util.translate(animation[1])}children.push({tag:"div",attrs:attrs})}return children}function renderContent(ctrl){var asWhite=ctrl.data.orientation==="white";if(ctrl.data.minimalDom)return renderMinimalDom(ctrl,asWhite);var positions=asWhite?util.allPos:util.invPos;var children=[];for(var i=0,len=positions.length;i<len;i++){children.push(renderSquare(ctrl,positions[i],asWhite))}if(ctrl.data.draggable.current.over&&ctrl.data.draggable.squareTarget)children.push(renderSquareTarget(ctrl,ctrl.data.draggable.current));if(ctrl.data.animation.current.fadings)ctrl.data.animation.current.fadings.forEach(function(p){children.push(renderFading(p))});if(ctrl.data.drawable.enabled)children.push(svg(ctrl));return children}function dragOrDraw(d,withDrag,withDraw){return function(e){if(d.drawable.enabled&&e.shiftKey)withDraw(d,e);else if(d.drawable.enabled&&util.isRightButton(e))withDraw(d,e);else if(!d.viewOnly)withDrag(d,e)}}function bindEvents(ctrl,el,context){var d=ctrl.data;var onstart=dragOrDraw(d,drag.start,draw.start);var onmove=dragOrDraw(d,drag.move,draw.move);var onend=dragOrDraw(d,drag.end,draw.end);var drawClear=util.partial(draw.clear,d);var startEvents=["touchstart","mousedown"];var moveEvents=["touchmove","mousemove"];var endEvents=["touchend","mouseup"];startEvents.forEach(function(ev){el.addEventListener(ev,onstart)});moveEvents.forEach(function(ev){document.addEventListener(ev,onmove)});endEvents.forEach(function(ev){document.addEventListener(ev,onend)});el.addEventListener("mousedown",drawClear);context.onunload=function(){startEvents.forEach(function(ev){el.removeEventListener(ev,onstart)});moveEvents.forEach(function(ev){document.removeEventListener(ev,onmove)});endEvents.forEach(function(ev){document.removeEventListener(ev,onend)});el.removeEventListener("mousedown",drawClear)}}function renderBoard(ctrl){return{tag:"div",attrs:{"class":"cg-board orientation-"+ctrl.data.orientation,config:function(el,isUpdate,context){if(isUpdate)return;if(!ctrl.data.viewOnly||ctrl.data.drawable.enabled)bindEvents(ctrl,el,context);ctrl.data.render=function(){m.render(el,renderContent(ctrl))};ctrl.data.renderRAF=function(){util.requestAnimationFrame(ctrl.data.render)};ctrl.data.bounds=el.getBoundingClientRect.bind(el);ctrl.data.element=el;ctrl.data.render()}},children:[]}}module.exports=function(ctrl){return{tag:"div",attrs:{config:function(el,isUpdate){if(!isUpdate)el.addEventListener("contextmenu",function(e){if(ctrl.data.disableContextMenu||ctrl.data.drawable.enabled){e.preventDefault();return false}})},"class":["cg-board-wrap",ctrl.data.viewOnly?"view-only":"manipulable",ctrl.data.minimalDom?"minimal-dom":"full-dom"].join(" ")},children:[renderBoard(ctrl)]}};